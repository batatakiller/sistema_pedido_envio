<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema Unificado de Envios</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        button { background: #6c5ce7; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        button:disabled { background: #a29bfe; cursor: not-allowed; }
        #log { background: #2d3436; color: #00cec9; padding: 15px; margin-top: 20px; border-radius: 5px; font-family: monospace; height: 300px; overflow-y: auto; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; color: #2d3436;">üöÄ Central de Automa√ß√£o</h2>
    <p>O sistema ir√°:</p>
    <ul style="color:#636e72;">
        <li>Buscar pedidos pendentes no Supabase.</li>
        <li>Validar telefones e buscar CPF na WorkConsultoria se necess√°rio.</li>
        <li>Enviar WhatsApp via Uazapi.</li>
        <li>Atualizar status automaticamente.</li>
    </ul>
    
    <button id="btnStart" onclick="rodarCiclo()">INICIAR ROB√î ü§ñ</button>
    <div id="log"></div>
</div>

<script>
    async function rodarCiclo() {
        const btn = document.getElementById('btnStart');
        const log = document.getElementById('log');
        
        if(!confirm("Deseja iniciar o processamento em lote?")) return;

        btn.disabled = true;
        btn.innerText = "Processando... (N√£o feche a aba)";
        log.style.display = 'block';

        let processando = true;

        while(processando) {
            try {
                log.innerHTML += `<div>üîÑ Buscando lote de pedidos...</div>`;
                log.scrollTop = log.scrollHeight;

                const req = await fetch('automacao.php');
                const res = await req.json();

                if (res.status === 'Concluido') {
                    log.innerHTML += `<div style="color:#fab1a0">‚úÖ ${res.msg}</div>`;
                    processando = false;
                } else {
                    res.detalhes.forEach(item => {
                        log.innerHTML += `<div>üì¶ Pedido ${item.pedido}: ${item.status_envio}</div>`;
                    });
                }
                
                // Pausa de 2 segundos para n√£o sobrecarregar
                await new Promise(r => setTimeout(r, 2000));

            } catch (e) {
                log.innerHTML += `<div style="color:red">‚ùå Erro Fatal: ${e.message}</div>`;
                processando = false;
            }
        }

        btn.disabled = false;
        btn.innerText = "INICIAR ROB√î ü§ñ";
        alert("Processo Finalizado!");
    }
</script>

</body>
</html>